datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum CitaEstado {
  pendiente
  confirmada
  cancelada
  cerrada

  @@map("cita_estado")
}

enum MovimientoTipo {
  earn
  redeem

  @@map("movimiento_tipo")
}

model Sucursal {
  id                 String             @id @default(uuid())
  nombre             String             @unique
  zonaHoraria        String             @default("America/Mexico_City") @map("zona_horaria")
  activa             Boolean            @default(true)
  createdAt          DateTime           @default(now()) @map("created_at")
  usuarioRoles       UsuarioRole[]
  empleadoSucursales EmpleadoSucursal[]
  existencias        Existencia[]
  serviciosSucursal  ServicioSucursal[]
  citas              Cita[]
  puntosMovimientos  PuntosMovimiento[]
  auditLogs          AuditLog[]
  notificaciones     Notificacion[]

  @@map("sucursales")
}

model Role {
  id           Int           @id @default(autoincrement())
  nombre       String        @unique
  descripcion  String?
  usuarioRoles UsuarioRole[]

  @@map("roles")
}

model Usuario {
  id                String             @id @default(uuid())
  nombre            String
  email             String             @unique
  password          String
  activo            Boolean            @default(true)
  createdAt         DateTime           @default(now()) @map("created_at")
  usuarioRoles      UsuarioRole[]
  citas             Cita[]
  puntosMovimientos PuntosMovimiento[]
  auditLogs         AuditLog[]
  notificaciones    Notificacion[]
  empleado          Empleado?

  @@map("usuarios")
}

model UsuarioRole {
  usuarioId  String
  rolId      Int
  sucursalId String
  usuario    Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [rolId], references: [id], onDelete: Cascade)
  sucursal   Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  @@id([usuarioId, rolId, sucursalId])
  @@map("usuarios_roles")
}

model Empleado {
  id                 String             @id @default(uuid())
  usuarioId          String             @unique @map("usuario_id")
  porcentajeComision Decimal            @default(0) @map("porcentaje_comision")
  activo             Boolean            @default(true)
  createdAt          DateTime           @default(now()) @map("created_at")
  usuario            Usuario            @relation(fields: [usuarioId], references: [id])
  sucursales         EmpleadoSucursal[]
  comisiones         Comision[]
  liquidaciones      Liquidacion[]
  ausencias          AusenciaEmpleado[]
  citas              Cita[]

  @@map("empleados")
}

model EmpleadoSucursal {
  empleadoId   String
  sucursalId   String
  rolLocal     String   @map("rol_local")
  predeterminada Boolean  @default(false)
  empleado     Empleado @relation(fields: [empleadoId], references: [id], onDelete: Cascade)
  sucursal     Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  @@id([empleadoId, sucursalId])
  @@map("empleados_sucursales")
}

model Servicio {
  id                  String              @id @default(uuid())
  nombre              String
  descripcion         String?
  precioBase          Decimal             @default(0) @map("precio_base")
  duracionMinutos     Int                 @map("duracion_minutos")
  activo              Boolean             @default(true)
  
  // Relaciones existentes
  serviciosSucursal   ServicioSucursal[]
  serviciosMateriales ServicioMaterial[]
  promocionesServicios PromocionServicio[]

  // --- CAMBIO SPRINT 1 ---
  // ANTES: citas Cita[] (Relación directa 1 a muchos)
  // AHORA: Relación a través de la tabla intermedia para permitir N servicios por cita
  citas               CitaServicio[]      

  @@map("servicios")
}

model ServicioSucursal {
  servicioId      String
  sucursalId      String
  precio          Decimal
  duracionMinutos Int      @map("duracion_minutos")
  activo          Boolean  @default(true)
  servicio        Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  sucursal        Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)

  @@id([servicioId, sucursalId])
  @@map("servicios_sucursal")
}

model Material {
  id                  String             @id @default(uuid())
  nombre              String
  unidad              String
  costoUnitario       Decimal            @default(0) @map("costo_unitario")
  existencias         Existencia[]
  serviciosMateriales ServicioMaterial[]

  @@map("materiales")
}

model Existencia {
  sucursalId  String
  materialId  String
  stockActual Decimal  @default(0) @map("stock_actual")
  stockMinimo Decimal  @default(0) @map("stock_minimo")
  updatedAt   DateTime @updatedAt @map("updated_at")
  sucursal    Sucursal @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  material    Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@id([sucursalId, materialId])
  @@map("existencias")
}

model ServicioMaterial {
  servicioId String
  materialId String
  cantidad   Decimal
  servicio   Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  material   Material @relation(fields: [materialId], references: [id], onDelete: Restrict)

  @@id([servicioId, materialId])
  @@map("servicios_materiales")
}

model Promocion {
  id                 String              @id @default(uuid())
  nombre             String
  descripcion        String?
  descuento          Decimal
  fechaInicio        DateTime            @map("fecha_inicio")
  fechaFin           DateTime            @map("fecha_fin")
  estado             Boolean             @default(true)
  sucursalId         String?
  tipo               String
  promocionServicios PromocionServicio[]
  promocionesAplicadas PromocionAplicada[]

  @@index([sucursalId])
  @@map("promociones")
}

model PromocionServicio {
  promocionId String
  servicioId  String
  promocion   Promocion @relation(fields: [promocionId], references: [id], onDelete: Cascade)
  servicio    Servicio  @relation(fields: [servicioId], references: [id], onDelete: Cascade)

  @@id([promocionId, servicioId])
  @@map("promociones_servicios")
}

model Cita {
  id                   String              @id @default(uuid())
  
  // Relaciones básicas
  usuarioId            String?
  empleadoId           String?
  sucursalId           String
  
  // --- CAMBIO SPRINT 1 ---
  // ELIMINAMOS la referencia directa a un solo servicio
  // servicioId        String?   <-- BORRAR ESTA LÍNEA
  // servicio          Servicio? <-- BORRAR ESTA LÍNEA

  fechaHora            DateTime            @map("fecha_hora")
  // Usamos el enum que ya definiste (asegúrate de que coincida con tu BD)
  estado               CitaEstado          @default(pendiente) 
  
  total                Decimal             @default(0)
  anticipo             Decimal             @default(0)
  notas                String?
  createdAt            DateTime            @default(now()) @map("created_at")
  
  // Relaciones (Foreign Keys)
  usuario              Usuario?            @relation(fields: [usuarioId], references: [id])
  empleado             Empleado?           @relation(fields: [empleadoId], references: [id])
  sucursal             Sucursal            @relation(fields: [sucursalId], references: [id])
  
  // NUEVO: Relación 1:N con la tabla intermedia de servicios
  servicios            CitaServicio[]

  // Relaciones financieras y de lealtad
  puntosMovimientos    PuntosMovimiento[]
  comisiones           Comision[]
  promocionesAplicadas PromocionAplicada[]

  // Índices para optimizar búsquedas
  @@index([usuarioId])
  @@index([empleadoId])
  @@index([sucursalId])
  // @@index([servicioId]) <-- BORRAR ESTE ÍNDICE TAMBIÉN
  @@index([fechaHora])
  
  @@map("citas")
}


 // NUEVO MODELO SPRINT 1: Tabla Intermedia Citas - Servicios
 // Permite que una cita tenga múltiples servicios y congela el precio al momento
 // de la venta (snapshot), protegiendo el historial si los precios base cambian.
 //
model CitaServicio {
  citaId     String   @map("cita_id")
  servicioId String   @map("servicio_id")
  
  // Snapshot del precio unitario al momento de agendar
  precio     Decimal  @default(0) 

  // Relaciones
  cita       Cita     @relation(fields: [citaId], references: [id], onDelete: Cascade)
  servicio   Servicio @relation(fields: [servicioId], references: [id])

  // Llave primaria compuesta (Una combinación única de Cita + Servicio)
  // Nota: Si permitimos repetir el mismo servicio en una cita, necesitaríamos un ID propio.
  // Por ahora asumimos que no se repite el mismo servicio ID en la misma cita.
  @@id([citaId, servicioId]) 
  
  @@map("citas_servicios")
}

model PromocionAplicada {
  id                 String     @id @default(uuid())
  citaId             String
  promocionId        String?
  porcentajeAplicado Decimal?   @map("porcentaje_aplicado")
  montoDescontado    Decimal?   @map("monto_descontado")
  aplicadoEn         DateTime   @default(now()) @map("aplicado_en")
  cita               Cita       @relation(fields: [citaId], references: [id], onDelete: Cascade)
  promocion          Promocion? @relation(fields: [promocionId], references: [id])

  @@index([citaId])
  @@index([promocionId])
  @@map("promociones_aplicadas")
}

model PuntosMovimiento {
  id         String         @id @default(uuid())
  usuarioId  String
  sucursalId String
  citaId     String
  tipo       MovimientoTipo
  cantidad   Int
  fecha      DateTime       @default(now())
  usuario    Usuario        @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  sucursal   Sucursal       @relation(fields: [sucursalId], references: [id], onDelete: Cascade)
  cita       Cita           @relation(fields: [citaId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([sucursalId])
  @@index([citaId])
  @@map("puntos_movimientos")
}

model Comision {
  id            String                @id @default(uuid())
  empleadoId    String
  citaId        String
  porcentaje    Decimal
  monto         Decimal
  generadoEn    DateTime              @default(now()) @map("generado_en")
  empleado      Empleado              @relation(fields: [empleadoId], references: [id], onDelete: Cascade)
  cita          Cita                  @relation(fields: [citaId], references: [id], onDelete: Cascade)
  liquidaciones LiquidacionComision[]

  @@index([empleadoId])
  @@index([citaId])
  @@map("comisiones")
}

model Liquidacion {
  id            String                @id @default(uuid())
  empleadoId    String
  periodoInicio DateTime              @map("periodo_inicio")
  periodoFin    DateTime              @map("periodo_fin")
  montoTotal    Decimal               @map("monto_total")
  generadoEn    DateTime              @default(now()) @map("generado_en")
  empleado      Empleado              @relation(fields: [empleadoId], references: [id], onDelete: Cascade)
  comisiones    LiquidacionComision[]

  @@index([empleadoId])
  @@map("liquidaciones")
}

model LiquidacionComision {
  liquidacionId String
  comisionId    String
  liquidacion   Liquidacion @relation(fields: [liquidacionId], references: [id], onDelete: Cascade)
  comision      Comision    @relation(fields: [comisionId], references: [id], onDelete: Cascade)

  @@id([liquidacionId, comisionId])
  @@map("liquidaciones_comisiones")
}

model AuditLog {
  id          String    @id @default(uuid())
  usuarioId   String?
  sucursalId  String?
  entidad     String
  accion      String
  descripcion String?
  metadata    Json?
  createdAt   DateTime  @default(now()) @map("created_at")
  usuario     Usuario?  @relation(fields: [usuarioId], references: [id])
  sucursal    Sucursal? @relation(fields: [sucursalId], references: [id])

  @@index([usuarioId])
  @@index([sucursalId])
  @@map("audit_log")
}

model Notificacion {
  id         String   @id @default(uuid())
  usuarioId  String
  sucursalId String
  tipo       String
  mensaje    String
  leida      Boolean  @default(false)
  createdAt  DateTime @default(now()) @map("created_at")
  usuario    Usuario  @relation(fields: [usuarioId], references: [id])
  sucursal   Sucursal @relation(fields: [sucursalId], references: [id])

  @@index([usuarioId])
  @@map("notificaciones")
}

model AusenciaEmpleado {
  id         String   @id @default(uuid())
  empleadoId String
  inicio     DateTime
  fin        DateTime
  motivo     String?
  createdAt  DateTime @default(now()) @map("created_at")
  empleado   Empleado @relation(fields: [empleadoId], references: [id])

  @@index([empleadoId])
  @@map("ausencias_empleado")
}
